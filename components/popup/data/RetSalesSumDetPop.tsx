import React, { useCallback, useEffect, useMemo, useState } from 'react';
import { defaultColDef, GridSetting } from '../../../libs/ag-grid';
import { useQuery } from '@tanstack/react-query';
import { authApi } from '../../../libs';
import { PopupLayout } from '../PopupLayout';
import { PopupFooter } from '../PopupFooter';
import { PopupContent } from '../PopupContent';
import TunedGrid from '../../grid/TunedGrid';
import { toastError } from '../../ToastMessage';
import { RetailSalesSummaryResponse } from '../../../generated';
import { Utils } from '../../../libs/utils';
import { ColDef, RowClassParams } from 'ag-grid-community';
import { useRetSalesSumStore } from '../../../stores/useRetSalesSumStore';

interface Props {
  onClose?: () => void;
  sellerId: number;
  sellerNm: string;
  searchType: string;
  startDate: string;
  endDate: string;
  prodAttrCd: string;
}

const RetSalesSumDetPop = ({ onClose, sellerId, startDate, endDate, prodAttrCd, searchType, sellerNm }: Props) => {
  console.log('sellerId ==>', sellerId);

  const [reqSellerId, setReqSellerId] = useState(sellerId);
  const [modalType, openModal] = useRetSalesSumStore((s) => [s.modalType, s.openModal]);
  const [retailSalesSummaryDetList, setRetailSalesSummaryDetList] = useState<RetailSalesSummaryResponse[]>([]);
  const [pinnedBottomRowData, setPinnedBottomRowData] = useState<any>([]); // Ìï©Í≥ÑÎç∞Ïù¥ÌÑ∞ ÎßåÎì§Í∏∞
  /** Ïª¨Îüº Ï†ïÏùò */
  const columnDefs = useMemo<ColDef<RetailSalesSummaryResponse>[]>(
    () => [
      {
        field: 'no',
        headerName: 'No',
        maxWidth: 40,
        minWidth: 40,
        cellStyle: GridSetting.CellStyle.CENTER,
        suppressHeaderMenuButton: true,
      },
      {
        field: 'workYmd',
        headerName: 'ÏòÅÏóÖÏùº',
        minWidth: 80,
        maxWidth: 80,
        cellStyle: GridSetting.CellStyle.LEFT,
        suppressHeaderMenuButton: true,
      },
      {
        field: 'partnerNm',
        headerName: 'ÏÇ¨ÏóÖÏûêÎ™Ö',
        minWidth: 80,
        maxWidth: 80,
        cellStyle: GridSetting.CellStyle.LEFT,
        suppressHeaderMenuButton: true,
      },
      {
        field: 'sellerNm',
        headerName: 'ÏÜåÎß§Ï≤ò',
        minWidth: 100,
        maxWidth: 100,
        cellStyle: GridSetting.CellStyle.CENTER,
        suppressHeaderMenuButton: true,
      },
      {
        field: 'gubun1',
        headerName: 'Íµ¨Î∂Ñ1',
        minWidth: 56,
        maxWidth: 56,
        cellStyle: GridSetting.CellStyle.CENTER,
        suppressHeaderMenuButton: true,
      },
      {
        field: 'gubun2',
        headerName: 'Íµ¨Î∂Ñ2',
        minWidth: 56,
        maxWidth: 56,
        cellStyle: GridSetting.CellStyle.CENTER,
        suppressHeaderMenuButton: true,
      },
      {
        field: `returnAmt`,
        headerName: 'ÎØ∏ÏàòÍ∏à',
        minWidth: 65,
        maxWidth: 65,
        cellStyle: GridSetting.CellStyle.RIGHT,
        suppressHeaderMenuButton: true,
        valueFormatter: (params) => {
          return Utils.setComma(params.value);
        },
      },
      {
        field: `chitCnt`,
        headerName: 'Ï†ÑÌëúÍ±¥Ïàò',
        minWidth: 56,
        maxWidth: 56,
        cellStyle: GridSetting.CellStyle.RIGHT,
        suppressHeaderMenuButton: true,
        valueFormatter: (params) => {
          return Utils.setComma(params.value);
        },
      },
      {
        field: `totSkuCnt`,
        headerName: 'ÌåêÎß§Îüâ',
        minWidth: 55,
        maxWidth: 55,
        cellStyle: GridSetting.CellStyle.RIGHT,
        suppressHeaderMenuButton: true,
        valueFormatter: (params) => {
          return Utils.setComma(params.value);
        },
      },
      {
        field: `totBackCnt`,
        headerName: 'Î∞òÌíàÎüâ',
        minWidth: 45,
        maxWidth: 45,
        cellStyle: GridSetting.CellStyle.RIGHT,
        suppressHeaderMenuButton: true,
        valueFormatter: (params) => {
          return Utils.setComma(params.value);
        },
      },
      {
        field: `backRate`,
        headerName: 'Î∞òÌíàÏú®',
        minWidth: 45,
        maxWidth: 45,
        cellStyle: GridSetting.CellStyle.RIGHT,
        suppressHeaderMenuButton: true,
      },
      {
        field: `totOrderAmt`,
        headerName: 'ÌåêÎß§Í∏àÏï°',
        minWidth: 70,
        maxWidth: 70,
        cellStyle: GridSetting.CellStyle.RIGHT,
        suppressHeaderMenuButton: true,
        valueFormatter: (params) => {
          return Utils.setComma(params.value);
        },
      },
      {
        field: `totBackAmt`,
        headerName: 'Î∞òÌíàÍ∏àÏï°',
        minWidth: 70,
        maxWidth: 70,
        cellStyle: GridSetting.CellStyle.RIGHT,
        suppressHeaderMenuButton: true,
        valueFormatter: (params) => {
          return Utils.setComma(params.value);
        },
      },
      {
        field: `totDcAmt`,
        headerName: 'Îã®Í∞ÄDC',
        minWidth: 60,
        maxWidth: 60,
        cellStyle: GridSetting.CellStyle.RIGHT,
        suppressHeaderMenuButton: true,
        valueFormatter: (params) => {
          return Utils.setComma(params.value);
        },
      },
      {
        field: `totDiscountAmt`,
        headerName: 'Ìï†Ïù∏Í∏àÏï°',
        minWidth: 60,
        maxWidth: 60,
        cellStyle: GridSetting.CellStyle.RIGHT,
        suppressHeaderMenuButton: true,
        valueFormatter: (params) => {
          return Utils.setComma(params.value);
        },
      },
      {
        field: `totIncomAmt`,
        headerName: 'Ïã§Îß§Ï∂úÍ∏àÏï°',
        minWidth: 70,
        maxWidth: 70,
        cellStyle: GridSetting.CellStyle.RIGHT,
        suppressHeaderMenuButton: true,
        valueFormatter: (params) => {
          return Utils.setComma(params.value);
        },
      },
      {
        field: `totCashAmt`,
        headerName: 'ÌòÑÍ∏àÏûÖÍ∏à',
        minWidth: 65,
        maxWidth: 65,
        cellStyle: GridSetting.CellStyle.RIGHT,
        suppressHeaderMenuButton: true,
        valueFormatter: (params) => {
          return Utils.setComma(params.value);
        },
      },
      {
        field: `totAccountAmt`,
        headerName: 'ÌÜµÏû•ÏûÖÍ∏à',
        minWidth: 70,
        maxWidth: 70,
        cellStyle: GridSetting.CellStyle.RIGHT,
        suppressHeaderMenuButton: true,
        valueFormatter: (params) => {
          return Utils.setComma(params.value);
        },
      },
      {
        field: `nowAmt`,
        headerName: 'ÎãπÍ∏∞ÏûîÏï°',
        minWidth: 70,
        maxWidth: 70,
        cellStyle: GridSetting.CellStyle.RIGHT,
        suppressHeaderMenuButton: true,
        valueFormatter: (params) => {
          return Utils.setComma(params.value);
        },
      },
      {
        field: `totVatAmt`,
        headerName: 'Î∂ÄÍ∞ÄÏÑ∏',
        minWidth: 70,
        maxWidth: 70,
        cellStyle: GridSetting.CellStyle.RIGHT,
        suppressHeaderMenuButton: true,
        valueFormatter: (params) => {
          return Utils.setComma(params.value);
        },
      },
      {
        field: `logisAmt`,
        headerName: 'Î¨ºÎ•òÎπÑ',
        minWidth: 56,
        maxWidth: 56,
        cellStyle: GridSetting.CellStyle.RIGHT,
        suppressHeaderMenuButton: true,
        valueFormatter: (params) => {
          return Utils.setComma(params.value);
        },
      },
    ],
    [],
  );

  const { data: detList, isSuccess: isDetSuccess } = useQuery(
    ['/omsData/retailSummaryDetList' + reqSellerId],
    () =>
      authApi.get('/omsData/retailSummaryDetList', {
        params: {
          searchType: searchType,
          sellerId: reqSellerId,
          prodAttrCd: prodAttrCd,
          startDate: startDate,
          endDate: endDate,
        },
      }),
    {
      enabled: !!reqSellerId,
    },
  );

  useEffect(() => {
    if (isDetSuccess) {
      const { resultCode, body, resultMessage } = detList.data;
      if (resultCode == 200) {
        setRetailSalesSummaryDetList(body || []);
        const summary = body.reduce(
          (
            acc: {
              returnAmt: number;
              chitCnt: number;
              totSkuCnt: number;
              totOrderAmt: number;
              totBackAmt: number;
              totBackCnt: number;
              totDcAmt: number;
              totIncomAmt: number;
              totCashAmt: number;
              totAccountAmt: number;
              nowAmt: number;
              totVatAmt: number;
              logisAmt: number;
            },
            data: RetailSalesSummaryResponse,
          ) => {
            //console.log('data==>', data);
            return {
              // Ï≤≠Íµ¨Ìï©Í≥Ñ
              returnAmt: acc.returnAmt + (data.returnAmt ?? 0),
              chitCnt: acc.chitCnt + (data.chitCnt ?? 0),
              totSkuCnt: acc.totSkuCnt + (data.totSkuCnt ?? 0),
              totOrderAmt: acc.totOrderAmt + (data.totOrderAmt ?? 0),
              totBackAmt: acc.totBackAmt + (data.totBackAmt ?? 0),
              totBackCnt: acc.totBackCnt + (data.totBackCnt ?? 0),
              totDcAmt: acc.totDcAmt + (data.totDcAmt ?? 0),
              totIncomAmt: acc.totIncomAmt + (data.totIncomAmt ?? 0),
              totCashAmt: acc.totCashAmt + (data.totCashAmt ?? 0),
              totAccountAmt: acc.totAccountAmt + (data.totAccountAmt ?? 0),
              nowAmt: acc.nowAmt + (data.nowAmt ?? 0),
              totVatAmt: acc.totVatAmt + (data.totVatAmt ?? 0),
              logisAmt: acc.logisAmt + (data.logisAmt ?? 0),
            };
          },
          {
            returnAmt: 0,
            chitCnt: 0,
            totSkuCnt: 0,
            totOrderAmt: 0,
            totBackAmt: 0,
            totBackCnt: 0,
            totDcAmt: 0,
            totIncomAmt: 0,
            totCashAmt: 0,
            totAccountAmt: 0,
            nowAmt: 0,
            totVatAmt: 0,
            logisAmt: 0,
          }, // Ï¥àÍ∏∞Í∞í ÏÑ§Ï†ï
        );
        setPinnedBottomRowData([summary]); // üëà Ìï©ÏÇ∞ Í≤∞Í≥º Í∞ùÏ≤¥ Î∞îÎ°ú Ï†ÑÎã¨
      } else {
        toastError('ÏÉÅÌíàÎ≥Ñ Ïã§Îß§Ï∂ú ÏàúÏúÑ Ï°∞Ìöå ÎèÑÏ§ë Î¨∏Ï†úÍ∞Ä Î∞úÏÉùÌïòÏòÄÏäµÎãàÎã§.');
        console.error(resultMessage);
      }
    }
  }, [isDetSuccess]);

  useEffect(() => {
    setReqSellerId(sellerId);
  }, [sellerId]);

  const getRowClass = useCallback((params: RowClassParams) => {
    let rtnValue = '';
    if (params.node.rowPinned === 'bottom') {
      // Ìï©Í≥Ñ Ìñâ Ïä§ÌÉÄÏùºÎßÅ
      rtnValue = rtnValue + 'ag-grid-pinned-row';
    }
    return rtnValue;
  }, []);

  return (
    <PopupLayout
      isEscClose={false}
      width={1500}
      open={modalType.type === 'DETAIL'}
      title={sellerNm + ' ÏÉÅÏÑ∏Î≥¥Í∏∞'}
      onClose={() => {
        if (onClose) {
          onClose();
        }
      }}
      footer={
        <PopupFooter>
          <div className="btnArea">
            <button
              className="btn"
              title="Îã´Í∏∞"
              onClick={() => {
                if (onClose) {
                  onClose();
                }
              }}
            >
              Îã´Í∏∞
            </button>
          </div>
        </PopupFooter>
      }
    >
      <PopupContent>
        <div>
          <TunedGrid<RetailSalesSummaryResponse>
            headerHeight={35}
            onGridReady={(e) => {
              e.api.sizeColumnsToFit();
            }}
            rowData={retailSalesSummaryDetList || []}
            columnDefs={columnDefs}
            defaultColDef={defaultColDef}
            pinnedBottomRowData={pinnedBottomRowData}
            getRowClass={getRowClass}
          />
        </div>
      </PopupContent>
    </PopupLayout>
  );
};
export default RetSalesSumDetPop;
